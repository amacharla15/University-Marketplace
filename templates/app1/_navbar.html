{# templates/app1/_navbar.html #}
{% load static %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
/>
<nav id="mainNav" class="navbar navbar-expand-lg navbar-light bg-light mb-4">
  <div class="container-fluid">
    <a
      class="navbar-brand btn-brand rounded-pill me-3"
      href="{% url 'home' %}"
    >
      <i class="bi bi-shop-window-fill me-1"></i>
      Marketplace
    </a>
    <button class="navbar-toggler" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">

        <li class="nav-item">
          <a class="btn btn-success btn-sm rounded-pill mx-1" href="{% url 'my_listings' %}">
            View My Listings
          </a>
        </li>
        <li class="nav-item">
          <a class="btn btn-danger btn-sm rounded-pill mx-1" href="{% url 'manage_listings' %}">
            Remove Your Listings
          </a>
        </li>
        

        <li class="nav-item">
          <a class="btn btn-about btn-sm rounded-pill mx-1" href="{% url 'about' %}">About</a>
        </li>

        <li class="nav-item">
            <label class="theme-switch mb-0" for="theme-toggle">
              <input type="checkbox" id="theme-toggle" />
              <span class="slider"></span>
            </label>
          </li>

        
        

        {% if not request.user.is_authenticated %}
        <li class="nav-item me-2">
          <a href="{% url 'login' %}"
            class="btn btn-primary btn-sm rounded-pill">
          Login
          </a>
        </li>
        <li class="nav-item">
          <a href="{% url 'signup' %}"
            class="btn btn-primary btn-sm rounded-pill">
          Sign Up
          </a>
        </li>

        {% else %}

          {# üîî unread‚Äêmessage bell #}
          <li class="nav-item dropdown me-2">
            <a class="nav-link position-relative" href="#" id="notifMenu"
               data-bs-toggle="dropdown" aria-expanded="false">
              üîî
              {% if unread_count %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  {{ unread_count }}
                </span>
              {% endif %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="notifMenu"
                style="min-width: 14rem;">
              <li class="dropdown-header d-flex justify-content-between align-items-center px-3">
                Messages
                <button type="button" class="btn-close btn-close-sm"
                        aria-label="Close" data-bs-toggle="dropdown"></button>
              </li>
              <li><hr class="dropdown-divider my-0"></li>

              {% if unread_notifs %}
                {% for n in unread_notifs %}
                  <li>
                    <span class="dropdown-item-text px-3">
                      New message on ‚Äú{{ n.title }}‚Äù
                    </span>
                  </li>
                {% endfor %}
              {% else %}
                <li><span class="dropdown-item-text text-muted px-3">
                  No new messages
                </span></li>
              {% endif %}
            </ul>
          </li>

          {# üìÖ pending‚Äêappointments calendar icon #}
          <li class="nav-item dropdown me-2">
            <a class="nav-link position-relative" href="#" id="apptMenu"
               data-bs-toggle="dropdown" aria-expanded="false">
              üìÖ
              {% if pending_count %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary">
                  {{ pending_count }}
                </span>
              {% endif %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="apptMenu"
                style="min-width: 16rem;">
              <li class="dropdown-header d-flex justify-content-between align-items-center px-3">
                Appointments
                <button type="button" class="btn-close btn-close-sm"
                        aria-label="Close" data-bs-toggle="dropdown"></button>
              </li>
              <li><hr class="dropdown-divider my-0"></li>

              {% if pending_appointments %}
                {% for appt in pending_appointments %}
                  <li class="d-flex align-items-center px-3 py-2">
                    <div class="flex-grow-1">
                      <small class="text-muted">
                        {{ appt.scheduled_time|date:"M j, g:i A" }}
                      </small><br>
                      {{ appt.listing.title }}
                    </div>
                    <form method="post"
                          action="{% url 'complete_appointment' appt.pk %}">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-success">
                        ‚úì
                      </button>
                    </form>
                  </li>
                {% endfor %}
              {% else %}
                <li><span class="dropdown-item-text text-muted px-3">
                  No upcoming
                </span></li>
              {% endif %}
            </ul>
          </li>
          {# üè≥Ô∏è recent‚Äêreports dropdown (staff only) #}

        {% if request.user.is_staff %}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'reported_listings' %}">
            Manage Reports
          </a>
        </li>
        
          <li class="nav-item dropdown me-2">
            <a class="nav-link position-relative" href="#" id="reportMenu"
              data-bs-toggle="dropdown" aria-expanded="false" aria-label="Reports">
              üè≥Ô∏è
              {% if report_count %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning">
                  {{ report_count }}
                </span>
              {% endif %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="reportMenu"
                style="min-width: 16rem;">
              <li class="dropdown-header px-3">
                Reports
              </li>
              <li><hr class="dropdown-divider my-0"></li>

              {% if recent_reports %}
                {% for rpt in recent_reports %}
                  <li>
                    <a href="{% url 'admin:app1_report_change' rpt.pk %}"   {# link each report to its admin edit page #}
                    class="dropdown-item px-3 py-2"
                    >
                    <strong>{{ rpt.listing.title }}</strong><br>
                    by {{ rpt.reporter.user.username }}<br>
                    <small class="text-muted">{{ rpt.created_at|date:"M j, g:i A" }}</small>
                    </a>
                  </li>
                {% endfor %}
              {% else %}
                <li><span class="dropdown-item-text text-muted px-3">
                  No reports
                </span></li>
              {% endif %}
              <li><hr class="dropdown-divider my-0"></li>
              <li>
                <a
                href="{% url 'admin:app1_report_changelist' %}"    {# ‚Äúview all reports‚Äù footer #}
                class="dropdown-item text-center"
                >
                  view all reports
                </a>
              </li>
            </ul>
          </li>
        {% endif %}


          {# New Listing #}
          <li class="nav-item">
            <a
              class="btn btn-new-listing btn-sm rounded-pill mx-2"
              href="{% url 'upload' %}"
            >
              New Listing
              <div class="small text-muted mt-1 text-center">
                Click here to post a new listing
              </div>
            </a>
          </li>

          
          
          

          <li class="nav-item">
            <a class="btn btn-wishlist btn-sm rounded-pill mx-1" href="{% url 'my_wishlist' %}">Wishlist</a>
          </li>
          
          {# User menu #}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userMenu"
               role="button" data-bs-toggle="dropdown" aria-expanded="false">
              {{ request.user.username }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
              <li><a class="dropdown-item" href="{% url 'logout' %}" onclick="window.location.reload()">Logout</a></li>
            </ul>
          </li>
        {% endif %}

      </ul>
    </div>
  </div>
</nav>

<style>
  /* brand pill: black background, white text */
  .navbar-brand.btn-brand {
    background-color: #000 !important;
    color: #fff !important;
    padding: .5rem 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: transform .2s, box-shadow .2s, background-color .2s;
  }
  .navbar-brand.btn-brand:hover {
    background-color: #333 !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    text-decoration: none;
    color: #fff !important;
  }
</style>





{# Mark messages read when üîî opens #}
<script>
  function getCookie(name) {
    let v = null;
    document.cookie.split(';').forEach(c => {
      let [k,val] = c.trim().split('=');
      if (k===name) v = decodeURIComponent(val);
    });
    return v;
  }
  document.addEventListener('DOMContentLoaded', () => {
    let bell = document.getElementById('notifMenu');
    if (bell) bell.addEventListener('shown.bs.dropdown', () => {
      fetch("{% url 'mark_read' %}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'X-CSRFToken': getCookie('csrftoken')}
      });
      let b = bell.querySelector('.badge'); if (b) b.remove();
    });
  });
</script>

<script>
  // every 20s, re-poll the unread count
  setInterval(async () => {
    try {
      const res = await fetch("{% url 'get_unread_count' %}", {
        credentials: "same-origin",
        headers: {'X-CSRFToken': getCookie('csrftoken')}
      });
      const { unread_count } = await res.json();
      const badge = document.querySelector('#notifMenu .badge');
      if (unread_count > 0) {
        if (badge) {
          badge.textContent = unread_count;
        } else {
          // create it if missing
          const span = document.createElement('span');
          span.className = "position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger";
          span.textContent = unread_count;
          document.querySelector('#notifMenu').append(span);
        }
      } else if (badge) {
        badge.remove();
      }
    } catch(e) {
      console.error("Failed to refresh notifications", e);
    }
  }, 20000);
</script>

<script>
  ;(function(){
  const chk  = document.getElementById('theme-toggle');
  const nav  = document.getElementById('mainNav');
  // initial read
  let theme = localStorage.getItem('theme')
           || (matchMedia('(prefers-color-scheme: dark)').matches
              ? 'dark'
              : 'light');
  // set checkbox state & apply 
  chk.checked = theme==='dark';
  apply(theme);

  chk.addEventListener('change', () => {
    theme = chk.checked ? 'dark':'light';
    localStorage.setItem('theme', theme);
    apply(theme);
  });

  function apply(t){
    document.documentElement.setAttribute('data-bs-theme', t);
    nav.classList.toggle('navbar-dark',  t==='dark');
    nav.classList.toggle('bg-dark',     t==='dark');
    nav.classList.toggle('navbar-light', t==='light');
    nav.classList.toggle('bg-light',    t==='light');
  }
})();

  </script>
  
